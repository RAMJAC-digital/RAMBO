# VBlank Timing and Ledger System Analysis

**Date:** October 19, 2025  
**Project:** RAMBO NES Emulator  
**Status:** 990/995 tests passing (99.5%)  

## Overview

This analysis provides a complete technical deep-dive into the PPU VBlank timing and ledger system in the RAMBO NES emulator. The analysis covers cycle-accurate timing, race condition detection, and the interaction between PPU signals and CPU interrupt handling.

## Documentation Structure

### 1. Quick Reference Guide
**File:** `vblank-quick-reference-2025-10-19.md` (7KB)

Start here for quick answers to key questions:
- When exactly does VBlank set/clear?
- How are race conditions detected?
- What's the difference between flag visibility and race suppression?
- How does $2002 read path work?

**Key Sections:**
- 5 key questions answered
- 4-step VBlank lifecycle
- Race condition details
- Correctness properties

### 2. Comprehensive Technical Analysis
**File:** `vblank-timing-and-ledger-system-2025-10-19.md` (20KB)

Deep technical reference with complete code walkthrough:
- VBlank signal generation (PPU level)
- VBlankLedger data structure (fields, invariants, methods)
- Flag query methods (isActive, isFlagVisible, hasRaceSuppression)
- $2002 read path with race detection
- NMI generation and edge detection
- Race condition handling details
- Complete lifecycle examples with timelines
- Test coverage overview

**Best For:**
- Understanding exact implementation
- Learning how each component works
- Code review reference
- Debugging VBlank-related issues

### 3. Visual Sequence Diagrams
**File:** `vblank-sequence-diagrams-2025-10-19.txt` (13KB)

ASCII diagrams showing execution flow and timing:
- Frame timeline (PPU scanlines)
- VBlankLedger state machine
- $2002 read sequences (normal vs race)
- NMI line management
- Edge detection logic
- Master clock calculations
- CPU cycle mapping
- Synchronization order

**Best For:**
- Visual learners
- Understanding state transitions
- Tracing execution paths
- Presentation/documentation

---

## Key Findings

### VBlank Signal Timing
- **Set:** Scanline 241, dot 1 (master clock cycle 82,181)
- **Clear:** Scanline 261, dot 1 (master clock cycle 89,001)
- Signals generated by `PpuLogic.tick()`, processed by `EmulationState.applyPpuCycleResult()`

### Clean Architecture
The system achieves separation of concerns through:
- **VBlankLedger:** Pure data structure (4 u64 fields)
- **PPU:** Generates timing signals at specific coordinates
- **EmulationState:** Orchestrates signal handling
- **PpuLogic.readRegister():** Computes flag visibility from ledger
- **CpuExecution:** Drives NMI line based on flag state

### Race Condition Handling
- **Detection:** Exact-cycle reads flagged via `last_race_cycle`
- **Flag Behavior:** All reads clear flag identically
- **NMI Impact:** Race suppresses NMI (separate from flag clearing)
- **Current Limitation:** "One cycle later" race cases not fully handled (low priority)

### Correctness Properties
✓ Flag visibility determined purely by ledger timestamps  
✓ All $2002 reads go through central coordinated path  
✓ Race detection happens before flag is computed  
✓ Timing events decoupled from CPU cycles  
✓ Debugger inspection doesn't trigger side effects  

---

## File Reference

### Source Code Files Analyzed
| File | Purpose |
|------|---------|
| `src/emulation/VBlankLedger.zig` | Core ledger structure (62 lines) |
| `src/ppu/logic/registers.zig` | $2002 read implementation (175 lines) |
| `src/ppu/Logic.zig` | PPU signal generation (432 lines) |
| `src/emulation/State.zig` | Orchestration & race detection (787 lines) |
| `src/emulation/cpu/execution.zig` | NMI line management |

### Test Files Referenced
| File | Purpose |
|------|---------|
| `tests/emulation/state/vblank_ledger_test.zig` | Core ledger tests |
| `tests/ppu/ppustatus_polling_test.zig` | $2002 behavior tests |
| `tests/ppu/vblank_nmi_timing_test.zig` | NMI generation tests |

### Related Documentation
| File | Purpose |
|------|---------|
| `docs/specs/vblank-flag-behavior-spec.md` | Hardware specification |
| `CLAUDE.md` (lines 241-256) | PPU warm-up and VBlank behavior |

---

## How to Use This Analysis

### For Code Review
1. Start with **Quick Reference** for context
2. Read relevant sections of **Technical Analysis** for detailed code
3. Use **Sequence Diagrams** to understand control flow

### For Bug Fixing
1. Check **Quick Reference** for likely cause
2. Reference **Technical Analysis** section on issue area
3. Use **Sequence Diagrams** to trace execution

### For Learning the System
1. Read **Quick Reference** end-to-end
2. Deep dive into **Technical Analysis** sections of interest
3. Study **Sequence Diagrams** for visual understanding

### For Documentation/Presentation
1. Use **Sequence Diagrams** as visual aids
2. Reference **Quick Reference** for summary
3. Cite **Technical Analysis** for detailed explanations

---

## Implementation Status

**Current Status:** FULLY FUNCTIONAL (990/995 tests passing)

### What Works
- VBlank flag generation at correct timing
- Flag visibility computation
- Flag clearing on $2002 reads
- Race condition detection (exact-cycle case)
- NMI line management
- CPU edge detection

### Known Limitations
- Race suppression for "one cycle later" case not fully implemented
- Does not currently affect any passing tests
- Low priority for future work

---

## Key Metrics

| Metric | Value |
|--------|-------|
| Test Pass Rate | 990/995 (99.5%) |
| VBlank Accuracy | Cycle-level (PPU clock granularity) |
| Detection Window | Master clock cycle precision |
| Race Cases Handled | 1 of 2 (exact-cycle) |
| Code Paths Analyzed | 8 main files |
| Lines of Core Logic | ~62 (VBlankLedger) |

---

## Next Steps

### For Implementers
- Complete "one cycle later" race suppression (if needed)
- Consider mid-frame PPUCTRL/PPUMASK changes (Phase 2 work)
- Profile for performance optimization opportunities

### For Maintainers
- Keep these documents synchronized with code changes
- Reference this analysis in code reviews
- Update test coverage as needed

### For Contributors
- Refer to these documents when working on VBlank code
- Maintain the functional style (pure data, explicit mutations)
- Follow the synchronization order pattern

---

## Technical Debt & Future Work

### High Priority
- None (system fully functional)

### Medium Priority
- Complete "one cycle later" race suppression (hardware-accurate but not affecting tests)

### Low Priority
- Consider consolidating test files
- Performance profiling of ledger operations (likely negligible)

---

## References

### Hardware Documentation
- [nesdev.org/wiki/PPU_frame_timing](https://www.nesdev.org/wiki/PPU_frame_timing)
- [nesdev.org/wiki/PPU_registers](https://www.nesdev.org/wiki/PPU_registers)
- [nesdev.org/wiki/NMI](https://www.nesdev.org/wiki/NMI)

### RAMBO Documentation
- `CLAUDE.md` - Project overview and guidance
- `docs/CURRENT-ISSUES.md` - Known issues and game compatibility
- `docs/architecture/` - Architecture documentation

---

## Questions?

For questions about this analysis, see:
1. **Quick Reference** for answers to common questions
2. **Technical Analysis** sections for detailed information
3. Source files for implementation details
4. Test files for usage examples

---

**Analysis Complete:** October 19, 2025  
**Next Review:** Before major VBlank changes  
**Maintainer:** Claude Code / Anthropic
