# BUG IDENTIFIED: Indirect Indexed Addressing
**Date:** 2025-10-19
**Status:** ROOT CAUSE FOUND - Ready to fix

---

## The Bug

**INDIRECT INDEXED ADDRESSING `LDA ($00),Y` is broken**

### Evidence

FixRTS function adds **0x26** to ZP[$00] when it should add **~0x04**.

The calculation:
- ROM does: `DEY; TYA; JSR AddAToByte0`
- This means Y-1 gets added to $00
- We see 0x26 added → Y was 0x27 before DEY

**Y should be ~5, but it's 0x27 (39 decimal)**

### Why Y is wrong

The calling function (F647) does:
```asm
F64B: JSR CopyReturnAddressToByte0  ; Sets $00-$01 to point to data
F64E: LDY #$00                      ; Start at 0
F650: LDA ($00),Y                   ; Read byte via indirect indexed
F652: CMP #$FF                      ; Check terminator
F654: BEQ done                      ; Exit if found
      ...process byte...
F668: INY                           ; Increment (3rd time this iteration)
F669: JMP $F650                     ; Loop back
```

Each loop iteration increments Y by 3. The loop should stop when reading 0xFF terminator.

**If Y=0x27 after loop:** Loop ran 13 iterations (0 + 3*13 = 39)
**Expected:** Loop should run ~1-2 iterations and find 0xFF

### Root Cause

`LDA ($00),Y` is **not reading the correct memory** → doesn't find 0xFF terminator → loops 13 times instead of 2.

Possible bugs:
1. **Address calculation wrong** - ($00),Y not computing correct effective address
2. **Wrong read location** - Reading from wrong page or offset
3. **Zero page read bug** - Not reading $00-$01 correctly to get base pointer

---

## Verification Test

Check our indirect indexed implementation:
- Does `LDA ($00),Y` with $00=$50, $01=$F6, Y=$02 read from $F652?
- Base pointer: [$01:$00] = $F650
- Add Y: $F650 + $02 = $F652
- Should read byte at $F652

---

## Next Steps

1. **Check microsteps.zig** - Find `fetchIndirectLow/High` for (ind),Y mode
2. **Verify address calculation** - Is effective_address = [$00-$01] + Y?
3. **Add logging** - Trace what address we're actually reading from
4. **Fix the bug**
5. **Re-run test** - Should pass after fix

---

**Files to check:**
- `src/emulation/cpu/microsteps.zig` - Address calculation
- `src/emulation/cpu/execution.zig` - Indirect indexed cycle sequence
