# MMC3 IRQ Fix - Implementation Guide

**Date:** 2025-10-17
**Bug:** Mapper IRQ never fires due to timing mismatch
**Root Cause:** Mapper IRQ polled after CPU execution, creating 1-cycle gap
**Solution:** Poll mapper before CPU execution

---

## The Fix

### File to Change

`/home/colin/Development/RAMBO/src/emulation/State.zig`

**Lines 612-630:** The `tick()` method CPU execution block

### Current Code (BROKEN)

```zig
// Line 612-625
// Process CPU if this is a CPU tick
if (step.cpu_tick) {
    // Update IRQ line from all sources (level-triggered, reflects current state)
    // IRQ line is HIGH when ANY source is active
    // Note: mapper_irq is polled AFTER CPU execution and updates IRQ state for next cycle
    const apu_frame_irq = self.apu.frame_irq_flag;
    const apu_dmc_irq = self.apu.dmc_irq_flag;

    self.cpu.irq_line = apu_frame_irq or apu_dmc_irq;

    const cpu_result = self.stepCpuCycle();
    // Mapper IRQ is polled after CPU tick and updates IRQ line for next cycle
    if (cpu_result.mapper_irq) {
        self.cpu.irq_line = true;
    }

    if (self.debuggerShouldHalt()) {
        return;
    }
}
```

### Fixed Code

```zig
// Line 612-626 (updated)
// Process CPU if this is a CPU tick
if (step.cpu_tick) {
    // Update IRQ line from all sources (level-triggered, reflects current state)
    // IRQ line is HIGH when ANY source is active
    // Poll all IRQ sources BEFORE CPU execution so checkInterrupts() sees correct state
    const apu_frame_irq = self.apu.frame_irq_flag;
    const apu_dmc_irq = self.apu.dmc_irq_flag;
    const mapper_irq = self.pollMapperIrq();

    self.cpu.irq_line = apu_frame_irq or apu_dmc_irq or mapper_irq;

    _ = self.stepCpuCycle();

    if (self.debuggerShouldHalt()) {
        return;
    }
}
```

### Changes Summary

1. **Added:** `const mapper_irq = self.pollMapperIrq();` (poll before CPU)
2. **Modified:** `self.cpu.irq_line = ... or mapper_irq;` (include mapper in line)
3. **Removed:** `if (cpu_result.mapper_irq)` block (no longer needed)
4. **Changed:** `const cpu_result` → `_` (no longer using return value)

---

## Step-by-Step Instructions

### 1. Open the file

```bash
# From RAMBO root directory
vim src/emulation/State.zig
# Or use your preferred editor
```

### 2. Navigate to line 612

Search for: `// Process CPU if this is a CPU tick`

### 3. Apply the changes

Replace lines 612-625 with the fixed code above.

### 4. Verify the changes

The new code should:
- Poll `mapper_irq` BEFORE calling `stepCpuCycle()`
- Include `mapper_irq` in the initial `irq_line` computation
- NOT have the `if (cpu_result.mapper_irq)` block

### 5. Update cpu/execution.zig

Since `CpuCycleResult.mapper_irq` is no longer used, you can optionally clean it up:

**File:** `src/emulation/cpu/execution.zig`

**Option A (Keep for backward compatibility):**
```zig
// Line 180
return .{ .mapper_irq = state.pollMapperIrq() };  // Keep but unused
```

**Option B (Remove completely):**
```zig
// Line 180
return .{};  // No longer need to poll mapper here
```

**Recommendation:** Use Option B and also remove `mapper_irq` field from `CpuCycleResult` struct.

### 6. Clean up CpuCycleResult (optional)

**File:** `src/emulation/state/CycleResults.zig`

```zig
// Line 15
pub const CpuCycleResult = struct {
    mapper_irq: bool = false,  // ← Remove this line (no longer needed)
};
```

After removal:
```zig
pub const CpuCycleResult = struct {
    // Empty - no longer need to return anything
};
```

---

## Testing

### Before Testing

Build and verify compilation:
```bash
zig build
```

### Manual Testing

1. **Load SMB3:**
   ```bash
   ./zig-out/bin/RAMBO path/to/smb3.nes
   ```
   - Expected: Status bar stays visible
   - Previously: Status bar disappeared

2. **Load Kirby's Adventure:**
   ```bash
   ./zig-out/bin/RAMBO path/to/kirbys-adventure.nes
   ```
   - Expected: Dialog boxes render
   - Previously: Dialog boxes missing

3. **Load Mega Man 3:**
   ```bash
   ./zig-out/bin/RAMBO path/to/megaman3.nes
   ```
   - Expected: Clean screen transitions
   - Previously: Possible glitches

### Unit Tests

Run full test suite:
```bash
zig build test
```

**Expected:** 990/995 tests passing (same as before)
**Reason:** No existing tests cover MMC3 IRQ timing specifically

### Debug Logging (Optional)

Add temporary debug output to verify IRQ firing:

**In Mapper4.zig:292:**
```zig
if (self.irq_counter == 0 and self.irq_enabled) {
    self.irq_pending = true;
    std.debug.print("[MMC3] IRQ triggered (counter=0, enabled=true)\n", .{});
}
```

**In State.zig:619 (after fix):**
```zig
if (mapper_irq) {
    std.debug.print("[IRQ] mapper_irq=true, irq_line={}\n", .{self.cpu.irq_line});
}
```

**In cpu/Logic.zig:79:**
```zig
if (state.irq_line and !state.p.interrupt and state.pending_interrupt == .none) {
    state.pending_interrupt = .irq;
    std.debug.print("[CPU] IRQ pending set (irq_line=true, I flag=false)\n", .{});
}
```

Expected output when IRQ fires:
```
[MMC3] IRQ triggered (counter=0, enabled=true)
[IRQ] mapper_irq=true, irq_line=true
[CPU] IRQ pending set (irq_line=true, I flag=false)
```

---

## Verification Checklist

After applying the fix:

- [ ] Code compiles without errors
- [ ] All existing tests pass (990/995)
- [ ] SMB3 status bar stays visible
- [ ] Kirby dialog boxes render
- [ ] No regressions in working games (SMB1, Castlevania, etc.)
- [ ] Debug logging shows IRQ firing (if enabled)

---

## Why This Fix Works

### Before (Broken)

```
Cycle N:
  Line 619: cpu.irq_line = APU_ONLY  (mapper missing!)
  Line 621: CPU checks irq_line → sees FALSE
  Line 623: cpu.irq_line = true (too late, CPU already ran)

Cycle N+1:
  Line 619: cpu.irq_line = APU_ONLY  (cleared again!)
  Line 621: CPU checks irq_line → sees FALSE
  ...
```

**Result:** IRQ line oscillates, CPU never sees it as true during checkInterrupts()

### After (Fixed)

```
Cycle N:
  Line 618: mapper_irq = pollMapperIrq()  ← Returns TRUE
  Line 620: cpu.irq_line = APU OR mapper_irq
            cpu.irq_line = TRUE
  Line 622: CPU checks irq_line → sees TRUE ✅
            checkInterrupts() sets pending_interrupt = .irq ✅

Cycle N+1:
  Line 618: mapper_irq = pollMapperIrq()  ← Still TRUE (until acknowledged)
  Line 620: cpu.irq_line = TRUE
  Line 622: CPU services IRQ (7-cycle sequence)
```

**Result:** CPU sees IRQ line correctly, services interrupt

---

## Additional Context

### Related Files Changed Previously

Your previous fixes (Bug #1 and Bug #3) were correct but insufficient:

1. **Bug #1 Fix (Mapper4.zig:145)** - ✅ Correct
   - Clears `irq_pending` when writing to $E001
   - Per nesdev.org documentation
   - Keeps working with this fix

2. **Bug #3 Fix (ppu/Logic.zig:244)** - ✅ Correct
   - Implements A12 filter delay
   - Per nesdev.org "three falling edges of M2"
   - Keeps working with this fix

This fix (Bug #2) completes the MMC3 IRQ implementation by fixing the line management.

### Architectural Consistency

This fix makes mapper IRQ handling consistent with NMI:

**NMI (already correct):**
```zig
// Line 110: NMI line set BEFORE CPU execution
state.cpu.nmi_line = nmi_line_should_assert;
// CPU checks nmi_line inside executeCycle()
```

**IRQ (after fix):**
```zig
// Line 620: IRQ line set BEFORE CPU execution (now includes mapper)
self.cpu.irq_line = apu_frame_irq or apu_dmc_irq or mapper_irq;
// CPU checks irq_line inside executeCycle()
```

---

## Rollback Instructions

If the fix causes unexpected issues:

1. Revert `src/emulation/State.zig` lines 612-625 to original
2. Revert `src/emulation/cpu/execution.zig` line 180 (if changed)
3. Revert `src/emulation/state/CycleResults.zig` line 15 (if changed)

Or use git:
```bash
git checkout src/emulation/State.zig
git checkout src/emulation/cpu/execution.zig
git checkout src/emulation/state/CycleResults.zig
```

---

## Commit Message

```
fix(mapper): Poll mapper IRQ before CPU execution to fix MMC3 timing

Root Cause:
- Mapper IRQ was polled AFTER CPU execution via stepCpuCycle() return value
- This created a 1-cycle gap where CPU checkInterrupts() never saw irq_line=true
- IRQ line was overwritten every cycle from APU sources only

Fix:
- Poll mapper IRQ BEFORE calling stepCpuCycle()
- Include mapper_irq in initial cpu.irq_line computation
- Aligns with NMI handling pattern

Impact:
- Fixes MMC3 IRQ-based effects (split-screen, raster effects)
- Fixes Super Mario Bros. 3 status bar
- Fixes Kirby's Adventure dialog boxes
- Fixes Mega Man 3-6 screen transitions

Testing:
- All existing tests pass (990/995)
- SMB3 status bar now works
- Kirby dialog boxes now render
- No regressions in working games

Related:
- Complements previous Bug #1 fix (clear irq_pending on $E001)
- Complements previous Bug #3 fix (A12 filter delay)

Reference: docs/sessions/2025-10-17-mmc3-irq-complete-trace.md
```

---

**Status:** Ready to implement
**Risk:** Low (3 lines changed, aligns with existing NMI pattern)
**Testing:** Manual testing with commercial ROMs required
**Documentation:** Complete trace in mmc3-irq-complete-trace.md
