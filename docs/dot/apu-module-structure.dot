// APU Module Complete Structure - All Types, Functions, and Relationships
// Based on actual source code audit from docs/architecture/codebase-inventory.md

digraph APU_Module {
    // Graph settings
    rankdir=TB;
    compound=true;
    splines=ortho;
    nodesep=0.6;
    ranksep=1.0;

    // Node defaults
    node [shape=box, style=filled, fillcolor=lightgray, fontname="Arial", fontsize=10];
    edge [fontname="Arial", fontsize=9];

    // ========== APU STATE (src/apu/State.zig) ==========
    subgraph cluster_apu_state {
        label="ApuState (src/apu/State.zig)\nNES APU Complete State";
        style=filled;
        fillcolor=lightblue;

        subgraph cluster_frame_counter {
            label="Frame Counter State";
            style=dashed;

            frame_state [label="Frame Counter:\lframe_counter_mode: bool  // 4-step (29830) or 5-step (37281)\lirq_inhibit: bool         // Bit 6 of $4017\lframe_irq_flag: bool      // Readable via $4015 bit 6\lframe_counter_cycles: u32 // Current cycle in sequence\l", fillcolor=lightcyan, shape=box];
        }

        subgraph cluster_channel_enables {
            label="Channel Enable Flags ($4015)";
            style=dashed;

            enable_flags [label="Channel Enables:\npulse1_enabled: bool\npulse2_enabled: bool\ntriangle_enabled: bool\nnoise_enabled: bool\ndmc_enabled: bool", fillcolor=wheat, shape=record];
        }

        subgraph cluster_length_counters {
            label="Length Counters";
            style=dashed;

            length_counters [label="Length Counters (u8):\lpulse1_length, pulse2_length\ltriangle_length, noise_length\l\lHalt Flags (bool):\lpulse1_halt, pulse2_halt\ltriangle_halt, noise_halt\l\lClocked @ 120 Hz\lDecrement when > 0 and !halt\l", fillcolor=lightyellow, shape=box];
        }

        subgraph cluster_envelopes {
            label="Envelope Generators";
            style=dashed;

            envelopes [label="Envelopes:\npulse1_envelope: Envelope\npulse2_envelope: Envelope\nnoise_envelope: Envelope\n\nClocked @ 240 Hz\nProvides volume control (0-15)", fillcolor=lightgreen, shape=record];
        }

        subgraph cluster_triangle {
            label="Triangle Linear Counter";
            style=dashed;

            triangle_linear [label="Linear Counter:\ntriangle_linear_counter: u7       // 0-127\ntriangle_linear_reload: u7        // Reload value\ntriangle_linear_reload_flag: bool\n\nClocked @ 240 Hz\nControls triangle timing", fillcolor=lightcoral, shape=record];
        }

        subgraph cluster_sweep_units {
            label="Sweep Units (Pulse Channels)";
            style=dashed;

            sweep_units [label="Sweep Units:\\npulse1_sweep: Sweep  // One's complement\\npulse2_sweep: Sweep  // Two's complement\\n\\nClocked @ 120 Hz\\nModulates period (frequency bends)", fillcolor=lightyellow, shape=record];
        }

        subgraph cluster_pulse_periods {
            label="Pulse Timers";
            style=dashed;

            pulse_periods [label="Timer Periods (11-bit):\npulse1_period: u11  // $4002/$4003\npulse2_period: u11  // $4006/$4007\n\nFrequency = CPU_CLOCK / (16 * (period + 1))", fillcolor=wheat, shape=record];
        }

        subgraph cluster_dmc_state {
            label="DMC (DPCM) Channel State";
            style=dashed;

            dmc_state [label="DMC State:\ndmc_active: bool\ndmc_irq_flag: bool       // Bit 7 of $4015\ndmc_irq_enabled: bool    // Bit 7 of $4010\ndmc_loop_flag: bool      // Bit 6 of $4010\n\nSample Addressing:\ndmc_sample_address: u8   // $C000 + (addr × 64)\ndmc_sample_length: u8    // (len × 16) + 1\ndmc_bytes_remaining: u16\ndmc_current_address: u16\n\nPlayback State:\ndmc_sample_buffer: u8\ndmc_sample_buffer_empty: bool\ndmc_shift_register: u8\ndmc_bits_remaining: u4   // 0-8\ndmc_silence_flag: bool\ndmc_output: u7           // 7-bit DAC (0-127)\n\nTiming:\ndmc_timer: u16\ndmc_timer_period: u16    // From rate table", fillcolor=lightcoral, shape=record];
        }

        subgraph cluster_register_storage {
            label="Register Storage";
            style=dashed;

            register_arrays [label="Write-Only Registers:\npulse1_regs: [4]u8   // $4000-$4003\npulse2_regs: [4]u8   // $4004-$4007\ntriangle_regs: [4]u8 // $4008-$400B\nnoise_regs: [4]u8    // $400C-$400F\ndmc_regs: [4]u8      // $4010-$4013", fillcolor=lightgray, shape=record];
        }

        subgraph cluster_apu_functions {
            label="Public API (src/apu/Apu.zig)";
            style=dashed;

            apu_api_note [label="Apu.zig Public Exports:\lState: @import(\"State.zig\")\lLogic: @import(\"Logic.zig\")\lDmc: @import(\"Dmc.zig\")\lEnvelope: @import(\"Envelope.zig\")\lSweep: @import(\"Sweep.zig\")\l\lType Aliases:\lApuState = State.ApuState\l", fillcolor=lightyellow, shape=box];

            apu_note_timers [label="NOTE: Noise and Triangle timers:\lImplementation status varies\lRefer to State.zig for exact fields\l", fillcolor=wheat, shape=note];
        }
    }

    // ========== APU LOGIC (src/apu/Logic.zig) ==========
    subgraph cluster_apu_logic {
        label="ApuLogic (src/apu/Logic.zig)\nFacade Delegating to Specialized Modules";
        style=filled;
        fillcolor=skyblue;

        logic_facade [label="Logic Facade:\ninit() ApuState\nreset(state) void\n\nDelegates to:\n- registers.zig (I/O)\n- frame_counter.zig (clocking)\n- Dmc.zig (DMC operations)", fillcolor=lightblue, shape=box3d];

        // Register operations
        logic_write_pulse1 [label="writePulse1(state, offset, value)\n// $4000-$4003", fillcolor=wheat];
        logic_write_pulse2 [label="writePulse2(state, offset, value)\n// $4004-$4007", fillcolor=wheat];
        logic_write_triangle [label="writeTriangle(state, offset, value)\n// $4008-$400B", fillcolor=wheat];
        logic_write_noise [label="writeNoise(state, offset, value)\n// $400C-$400F", fillcolor=wheat];
        logic_write_dmc [label="writeDmc(state, offset, value)\n// $4010-$4013", fillcolor=wheat];
        logic_write_control [label="writeControl(state, value)\n// $4015: Channel enables", fillcolor=lightcoral];
        logic_write_frame [label="writeFrameCounter(state, value)\n// $4017: Mode/IRQ inhibit", fillcolor=lightcoral];
        logic_read_status [label="readStatus(state) u8\n// $4015: Status read", fillcolor=lightgreen];

        // Frame counter operations
        logic_tick_frame [label="tickFrameCounter(state) bool\n// Called every CPU cycle\n// Returns true if IRQ should fire", fillcolor=yellow, shape=box3d];
        logic_clock_linear [label="clockLinearCounter(state)\n// Public for testing", fillcolor=lightyellow];

        // DMC operations
        logic_get_sample_addr [label="getSampleAddress(state) u16\n// For DMA fetch", fillcolor=lightcoral];
        logic_load_sample [label="loadSampleByte(state, value)\n// Called by DMA", fillcolor=lightcoral];
        logic_tick_dmc [label="tickDmc(state) bool\n// Returns true if DMA needed", fillcolor=yellow, shape=box3d];
    }

    // ========== ENVELOPE (src/apu/Envelope.zig) ==========
    subgraph cluster_envelope {
        label="Envelope (src/apu/Envelope.zig)\nReusable Volume Control Component";
        style=filled;
        fillcolor=palegreen;

        envelope_struct [label="Envelope struct:\nstart_flag: bool       // Restart trigger\ndivider: u4            // Countdown (0-15)\ndecay_level: u4        // Output (0-15)\nloop_flag: bool        // Loop at 0 vs stay at 0\nconstant_volume: bool  // Constant or decay\nvolume_envelope: u4    // Volume value (0-15)", fillcolor=palegreen, shape=record];

        envelope_clock [label="clock(envelope) void\n// Called @ 240 Hz (quarter-frame)\n// SIDE EFFECTS:\n// - Clears start_flag if set\n// - Decrements divider\n// - Decrements decay_level\n// - Loops decay_level if loop_flag", fillcolor=lightgreen, shape=box3d];

        envelope_get_volume [label="getVolume(envelope) u4\n// Returns constant or decay level\n// Pure: No side effects", fillcolor=palegreen];

        envelope_restart [label="restart(envelope) void\n// Sets start_flag\n// Called on $4003/$4007/$400F write", fillcolor=wheat];

        envelope_write [label="writeControl(envelope, value) void\n// Parse --LC VVVV format\n// L=loop, C=constant, V=volume", fillcolor=wheat];
    }

    // ========== SWEEP (src/apu/Sweep.zig) ==========
    subgraph cluster_sweep {
        label="Sweep (src/apu/Sweep.zig)\nPulse Frequency Modulation";
        style=filled;
        fillcolor=lightyellow;

        sweep_struct [label="Sweep struct:\nenabled: bool       // Bit 7 of $4001/$4005\ndivider: u3         // Countdown (0-7)\nperiod: u3          // Reload value (0-7)\nnegate: bool        // Decrease vs increase\nshift: u3           // Change amount (0-7)\nreload_flag: bool   // Set on register write", fillcolor=lightyellow, shape=record];

        sweep_clock [label="clock(sweep, period, ones_complement) void\n// Called @ 120 Hz (half-frame)\n// Parameters:\n//   period: *u11 (modified if sweep triggers)\n//   ones_complement: true=Pulse1, false=Pulse2\n// SIDE EFFECTS:\n// - Modifies period if enabled/shift!=0/target valid\n// - Decrements divider\n// - Clears reload_flag", fillcolor=yellow, shape=box3d];

        sweep_is_muting [label="isMuting(sweep, period, ones_complement) bool\n// Returns true if:\n//   period < 8 OR\n//   target > $7FF (when negate=0)\n// Pure: No side effects", fillcolor=lightyellow];

        sweep_write [label="writeControl(sweep, value) void\n// Parse EPPP NSSS format\n// Sets reload_flag", fillcolor=wheat];
    }

    // ========== DMC (src/apu/Dmc.zig) ==========
    subgraph cluster_dmc {
        label="Dmc (src/apu/Dmc.zig)\nDelta Modulation Channel";
        style=filled;
        fillcolor=lightcoral;

        dmc_rate_table [label="RATE_TABLE_NTSC: [16]u16\nTimer periods in CPU cycles:\n428, 380, 340, 320, 286, 254, 226, 214\n190, 160, 142, 128, 106,  84,  72,  54", fillcolor=wheat, shape=record];

        dmc_tick [label="tick(apu) bool\n// Called every CPU cycle\n// SIDE EFFECTS:\n// - Decrements timer\n// - Clocks output unit when timer expires\n// Returns: true if DMA needed", fillcolor=yellow, shape=box3d];

        dmc_clock_output [label="clockOutputUnit(apu) bool\n// Shifts out 1 bit\n// Modifies output level (+2 or -2)\n// SIDE EFFECTS:\n// - Shifts dmc_shift_register\n// - Decrements dmc_bits_remaining\n// - Modifies dmc_output (clamped 0-127)\n// - Sets silence flag if buffer empty\n// Returns: true if DMA needed", fillcolor=lightcoral, shape=box3d];

        dmc_load_sample [label="loadSampleByte(apu, byte) void\n// Called by DMA\n// SIDE EFFECTS:\n// - Fills sample buffer\n// - Exits silence mode if applicable\n// - Decrements bytes_remaining\n// - Increments current_address\n// - Triggers loop/IRQ on completion", fillcolor=lightcoral, shape=box3d];

        dmc_start [label="startSample(apu) void\n// Reload address/length if bytes_remaining=0", fillcolor=wheat];
        dmc_stop [label="stopSample(apu) void\n// Set bytes_remaining=0", fillcolor=wheat];

        dmc_write_4010 [label="write4010(apu, value) void\n// Bit 7: IRQ enable\n// Bit 6: Loop flag\n// Bits 0-3: Rate index", fillcolor=wheat];
        dmc_write_4011 [label="write4011(apu, value) void\n// Bits 0-6: Direct load output", fillcolor=wheat];
        dmc_write_4012 [label="write4012(apu, value) void\n// Sample address register", fillcolor=wheat];
        dmc_write_4013 [label="write4013(apu, value) void\n// Sample length register", fillcolor=wheat];
    }

    // ========== REGISTERS (src/apu/logic/registers.zig) ==========
    subgraph cluster_registers {
        label="Register I/O (src/apu/logic/registers.zig)\nCPU Register Interface";
        style=filled;
        fillcolor=wheat;

        reg_write_pulse1 [label="writePulse1(state, offset, value)\n$4000: DDLC VVVV → envelope, halt\n$4001: EPPP NSSS → sweep\n$4002: TTTT TTTT → period low\n$4003: LLLL Lttt → length, period high, restart", fillcolor=wheat, shape=record];

        reg_write_pulse2 [label="writePulse2(state, offset, value)\n$4004-$4007: Same as Pulse1", fillcolor=wheat, shape=record];

        reg_write_triangle [label="writeTriangle(state, offset, value)\n$4008: CRRR RRRR → halt, linear reload\n$400B: LLLL Lttt → length, reload flag", fillcolor=wheat, shape=record];

        reg_write_noise [label="writeNoise(state, offset, value)\n$400C: --LC VVVV → envelope, halt\n$400F: LLLL L--- → length, restart", fillcolor=wheat, shape=record];

        reg_write_dmc [label="writeDmc(state, offset, value)\nDelegate to Dmc.zig functions", fillcolor=wheat, shape=record];

        reg_write_control [label="writeControl(state, value) void\n$4015: ---D NT21\nBits 0-4: Channel enables\nSIDE EFFECTS:\n- Disable: Clear length counters IMMEDIATELY\n- DMC enable: Start sample if not playing\n- DMC disable: Stop sample\n- Clear DMC IRQ flag", fillcolor=lightcoral, shape=record];

        reg_write_frame_counter [label="writeFrameCounter(state, value) void\n$4017: MI-- ----\nBit 7: Mode (0=4-step, 1=5-step)\nBit 6: IRQ inhibit\nSIDE EFFECTS:\n- 5-step mode: Clock quarter+half IMMEDIATELY\n- Reset frame counter cycles\n- IRQ inhibit: Clear frame IRQ flag", fillcolor=lightcoral, shape=record];

        reg_read_status [label="readStatus(state) u8\l$4015: IF-D NT21\lBit 7: DMC IRQ\lBit 6: Frame IRQ\lBit 4: DMC active\lBits 0-3: Length > 0\l\lNOTE: Does NOT clear flags\l(clearFrameIrq must be called separately)\l", fillcolor=lightgreen, shape=box];

        reg_clear_frame_irq [label="clearFrameIrq(state) void\nSide effect of reading $4015", fillcolor=lightgreen];
    }

    // ========== FRAME COUNTER (src/apu/logic/frame_counter.zig) ==========
    subgraph cluster_frame_counter_logic {
        label="Frame Counter Logic (src/apu/logic/frame_counter.zig)\nSequencer @ 240 Hz / 120 Hz";
        style=filled;
        fillcolor=lightyellow;

        frame_timing_4step [label="4-Step Mode (29830 cycles total):\lCycle 7457:  Quarter-frame (envelopes, linear)\lCycle 14913: Quarter + Half (envelopes, linear, length, sweep)\lCycle 22371: Quarter-frame\lCycle 29829: Half-frame + IRQ (if !irq_inhibit)\lCycles 29829-29831: IRQ flag actively re-set\l\lTotal duration: 29830 CPU cycles (NTSC)\l", fillcolor=lightyellow, shape=box];

        frame_timing_5step [label="5-Step Mode (37281 cycles total):\lCycle 7457:  Quarter-frame\lCycle 14913: Quarter + Half\lCycle 22371: Quarter-frame\lCycle 37281: Quarter + Half (no IRQ)\lReset to 0\l\lTotal duration: 37281 CPU cycles (NTSC)\l", fillcolor=lightyellow, shape=box];

        frame_clock_quarter [label="clockQuarterFrame(state) void\n// Called @ 240 Hz\nSIDE EFFECTS:\n- Clock all 3 envelopes\n- Clock triangle linear counter", fillcolor=lightgreen, shape=box3d];

        frame_clock_half [label="clockHalfFrame(state) void\n// Called @ 120 Hz\nSIDE EFFECTS:\n- Clock all 4 length counters\n- Clock both sweep units", fillcolor=lightgreen, shape=box3d];

        frame_clock_length [label="clockLengthCounters(state) void\nDecrement each channel's length (if > 0 and !halt)", fillcolor=lightyellow];

        frame_tick [label="tickFrameCounter(state) bool\n// Called every CPU cycle\nSIDE EFFECTS:\n- Increments frame_counter_cycles\n- Triggers quarter/half events at specific cycles\n- Sets frame_irq_flag (4-step mode)\nReturns: true if IRQ should fire", fillcolor=yellow, shape=box3d];

        frame_clock_immediately [label="clockImmediately(state) void\nCalled when $4017 written with 5-step mode\nTriggers quarter + half immediately", fillcolor=lightcoral];
    }

    // ========== TABLES (src/apu/logic/tables.zig) ==========
    subgraph cluster_tables {
        label="Lookup Tables (src/apu/logic/tables.zig)\nComptime Constants";
        style=filled;
        fillcolor=lightgray;

        table_dmc_ntsc [label="DMC_RATE_TABLE_NTSC: [16]u16\n428, 380, 340, 320, 286, 254, 226, 214\n190, 160, 142, 128, 106,  84,  72,  54", fillcolor=wheat, shape=record];

        table_dmc_pal [label="DMC_RATE_TABLE_PAL: [16]u16\n398, 354, 316, 298, 276, 236, 210, 198\n176, 148, 132, 118,  98,  78,  66,  50", fillcolor=wheat, shape=record];

        table_length [label="LENGTH_TABLE: [32]u8\n10, 254, 20,   2,  40,   4,  80,   6\n160,  8, 60,  10,  14,  12,  26,  14\n 12, 16, 24,  18,  48,  20,  96,  22\n192, 24, 72,  26,  16,  28,  32,  30\n\nIndexed by bits 3-7 of $4003/$4007/$400B/$400F", fillcolor=wheat, shape=record];
    }

    // ========== MAIN DATA FLOW ==========

    // Logic facade delegation
    logic_facade -> logic_write_pulse1 [label="delegate", color=blue];
    logic_facade -> logic_write_pulse2 [label="delegate", color=blue];
    logic_facade -> logic_write_triangle [label="delegate", color=blue];
    logic_facade -> logic_write_noise [label="delegate", color=blue];
    logic_facade -> logic_write_dmc [label="delegate", color=blue];
    logic_facade -> logic_write_control [label="delegate", color=blue];
    logic_facade -> logic_write_frame [label="delegate", color=blue];
    logic_facade -> logic_read_status [label="delegate", color=blue];
    logic_facade -> logic_tick_frame [label="delegate", color=blue, penwidth=2];
    logic_facade -> logic_tick_dmc [label="delegate", color=blue, penwidth=2];

    // Register I/O delegation
    logic_write_pulse1 -> reg_write_pulse1 [label="call", color=green];
    logic_write_pulse2 -> reg_write_pulse2 [label="call", color=green];
    logic_write_triangle -> reg_write_triangle [label="call", color=green];
    logic_write_noise -> reg_write_noise [label="call", color=green];
    logic_write_dmc -> reg_write_dmc [label="call", color=green];
    logic_write_control -> reg_write_control [label="call", color=red, penwidth=2];
    logic_write_frame -> reg_write_frame_counter [label="call", color=red, penwidth=2];
    logic_read_status -> reg_read_status [label="call", color=blue];

    // Frame counter delegation
    logic_tick_frame -> frame_tick [label="call", color=blue, penwidth=2];
    logic_clock_linear -> frame_clock_quarter [label="call", color=orange];

    // DMC delegation
    logic_tick_dmc -> dmc_tick [label="call", color=blue, penwidth=2];
    logic_load_sample -> dmc_load_sample [label="call", color=red];
    logic_get_sample_addr -> dmc_state [label="read", color=blue, style=dashed];

    // Envelope operations
    reg_write_pulse1 -> envelope_write [lhead=cluster_envelope, label="configure envelope", color=orange];
    reg_write_pulse1 -> envelope_restart [lhead=cluster_envelope, label="on $4003 write", color=orange];
    frame_clock_quarter -> envelope_clock [lhead=cluster_envelope, label="clock @ 240 Hz", color=green];
    envelopes -> envelope_struct [label="contains 3 instances", style=dotted];

    // Sweep operations
    reg_write_pulse1 -> sweep_write [lhead=cluster_sweep, label="on $4001 write", color=orange];
    frame_clock_half -> sweep_clock [lhead=cluster_sweep, label="clock @ 120 Hz", color=green];
    sweep_clock -> pulse_periods [label="modifies period", color=red];
    sweep_units -> sweep_struct [label="contains 2 instances", style=dotted];

    // Linear counter
    reg_write_triangle -> triangle_linear [label="set reload flag", color=orange];
    frame_clock_quarter -> frame_clock_length [ltail=cluster_frame_counter_logic, label="includes clockLinearCounter", color=green];

    // Length counters
    reg_write_pulse1 -> length_counters [label="load from table", color=orange];
    reg_write_control -> length_counters [label="clear on disable", color=red];
    frame_clock_half -> frame_clock_length [label="call", color=green];
    frame_clock_length -> length_counters [label="decrement", color=red];

    // Frame counter timing
    frame_tick -> frame_clock_quarter [label="at specific cycles", color=green];
    frame_tick -> frame_clock_half [label="at specific cycles", color=green];
    frame_tick -> frame_state [label="modifies cycles, IRQ flag", color=red];
    reg_write_frame_counter -> frame_clock_immediately [label="5-step mode", color=red];

    // DMC operations
    dmc_tick -> dmc_clock_output [label="on timer expiration", color=green];
    dmc_clock_output -> dmc_state [label="modify output, shift register", color=red];
    dmc_load_sample -> dmc_state [label="fill buffer, update address", color=red];
    reg_write_dmc -> dmc_write_4010 [lhead=cluster_dmc, label="configure DMC", color=orange];
    reg_write_control -> dmc_start [lhead=cluster_dmc, label="on enable", color=green];
    reg_write_control -> dmc_stop [lhead=cluster_dmc, label="on disable", color=red];

    // Table lookups
    reg_write_pulse1 -> table_length [label="load length", style=dashed];
    reg_write_dmc -> table_dmc_ntsc [label="load rate", style=dashed];
    dmc_write_4010 -> dmc_rate_table [label="index", style=dashed];

    // State modification
    reg_write_pulse1 -> enable_flags [label="via writeControl", color=orange];
    reg_write_pulse1 -> register_arrays [label="store value", color=blue];

    // Legend
    subgraph cluster_legend {
        label="Legend";
        style=filled;
        fillcolor=white;
        rank=sink;

        legend_call [label="Solid: Direct call/contains", penwidth=2];
        legend_delegate [label="Blue: Main execution flow", color=blue, penwidth=2];
        legend_data [label="Dashed: Data lookup/read", style=dashed];
        legend_side [label="Red: Mutation/side effect", color=red];
        legend_clock [label="Green: Periodic clocking", color=green];
        legend_config [label="Orange: Configuration/setup", color=orange];
    }

    // Ownership annotation
    subgraph cluster_ownership {
        label="Ownership & Lifetime";
        style=filled;
        fillcolor=white;
        rank=sink;

        own_state [label="ApuState:\nOwned by EmulationState\nStack-allocated\nNo heap usage\nDirect containment:\n- 3 Envelope instances\n- 2 Sweep instances\n- DMC state inline", fillcolor=lightcyan, shape=note];
        own_logic [label="Logic Functions:\nStateless pure functions\nNo allocations\nRT-safe\nAll side effects via state pointer", fillcolor=palegreen, shape=note];
        own_tables [label="Lookup Tables:\nComptime-initialized const\nRead-only\nZero-cost", fillcolor=lightyellow, shape=note];
    }

    // Side effects summary
    subgraph cluster_side_effects {
        label="Side Effects Summary";
        style=filled;
        fillcolor=white;
        rank=sink;

        side_state [label="State Mutation:\n- Frame counter cycles/flags\n- Channel enable flags\n- Length counters (decrement @ 120 Hz)\n- Envelopes (clock @ 240 Hz)\n- Sweep units (clock @ 120 Hz, modify period)\n- Linear counter (clock @ 240 Hz)\n- DMC output/shift/buffer state", fillcolor=lightyellow, shape=note];
        side_registers [label="Register Writes:\n$4000-$4003: Pulse 1 config\n$4004-$4007: Pulse 2 config\n$4008-$400B: Triangle config\n$400C-$400F: Noise config\n$4010-$4013: DMC config\n$4015: Channel enables (clear length on disable)\n$4017: Frame counter (5-step: immediate clock)", fillcolor=lightcoral, shape=note];
        side_timing [label="Timing:\n- Frame counter @ CPU cycle rate\n- Quarter-frame events @ 240 Hz\n- Half-frame events @ 120 Hz\n- DMC timer @ CPU cycle rate\n- IRQ generation (frame counter, DMC)", fillcolor=wheat, shape=note];
        side_dma [label="DMA Triggers:\n- DMC sample fetch when buffer empty\n- CPU stall during DMA read\n- Address auto-increment\n- Loop/IRQ on sample completion", fillcolor=lightcoral, shape=note];
    }

    // Critical timing annotation
    subgraph cluster_critical_timing {
        label="Critical Timing Behaviors";
        style=filled;
        fillcolor=white;
        rank=sink;

        timing_frame_irq [label="Frame IRQ Edge Case:\n4-step mode cycles 29829-29831\nIRQ flag ACTIVELY RE-SET during this window\nEven if $4015 read clears flag at 29829,\nit gets set again on 29830-29831", fillcolor=yellow, shape=note];
        timing_5step_immediate [label="$4017 Write to 5-Step Mode:\nIMMEDIATELY clocks quarter + half frame\nTested by AccuracyCoin (error code 3)", fillcolor=yellow, shape=note];
        timing_dmc_irq [label="DMC IRQ Generation:\nSample completes: bytes_remaining → 0\nIf loop_flag: Restart sample\nIf irq_enabled: Set dmc_irq_flag\nRead $4015 bit 7 to check, write $4015 to clear", fillcolor=yellow, shape=note];
    }

    // Register map reference
    subgraph cluster_register_map {
        label="APU Register Map ($4000-$4017)";
        style=filled;
        fillcolor=white;
        rank=sink;

        reg_map [label="$4000-$4003: Pulse 1 (duty, envelope, sweep, timer, length)\n$4004-$4007: Pulse 2 (duty, envelope, sweep, timer, length)\n$4008-$400B: Triangle (linear counter, timer, length)\n$400C-$400F: Noise (envelope, mode, period, length)\n$4010-$4013: DMC (rate/loop/IRQ, direct load, address, length)\n$4015: Status/Control (R: IRQ/length, W: enables)\n$4017: Frame Counter (mode, IRQ inhibit)", fillcolor=wheat, shape=note];
    }
}
