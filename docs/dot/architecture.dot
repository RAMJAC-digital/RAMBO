// RAMBO NES Emulator - System Architecture
// Generated: 2025-10-09
// This diagram shows the complete system architecture with all major components

digraph RAMBO_Architecture {
    // Graph settings
    rankdir=TB;
    compound=true;
    newrank=true;
    splines=ortho;
    nodesep=0.5;
    ranksep=0.8;

    // Global node defaults
    node [shape=box, style=filled, fillcolor=lightgray, fontname="Arial"];
    edge [fontname="Arial", fontsize=10];

    // ========== MAIN ENTRY POINT ==========
    subgraph cluster_main {
        label="Entry Point";
        style=filled;
        fillcolor=lightyellow;

        main [label="main.zig\n(CLI Entry Point)", fillcolor=gold, shape=box3d];
    }

    // ========== THREADING LAYER ==========
    subgraph cluster_threads {
        label="Thread Architecture\n(3-Thread Mailbox Pattern)";
        style=filled;
        fillcolor=lightcyan;
        rank=same;

        main_thread [label="Main Thread\n(Coordinator)", fillcolor=lightblue];
        emu_thread [label="Emulation Thread\n(RT-Safe)", fillcolor=lightgreen];
        render_thread [label="Render Thread\n(Wayland+Vulkan)", fillcolor=lightcoral];
    }

    // ========== MAILBOX COMMUNICATION ==========
    subgraph cluster_mailboxes {
        label="Lock-Free Mailboxes\n(Thread Communication)";
        style=filled;
        fillcolor=lavender;

        subgraph cluster_mailbox_core {
            label="Core Mailboxes";
            style=dashed;

            frame_mb [label="FrameMailbox\n(Double-Buffered)", shape=cylinder];
            ctrl_mb [label="ControllerInputMailbox\n(Button State)", shape=cylinder];
            dbg_cmd_mb [label="DebugCommandMailbox\n(Breakpoints)", shape=cylinder];
            dbg_evt_mb [label="DebugEventMailbox\n(Events)", shape=cylinder];
        }

        subgraph cluster_mailbox_window {
            label="Window Events";
            style=dashed;

            xdg_input_mb [label="XdgInputEventMailbox\n(Keyboard)", shape=cylinder];
            xdg_window_mb [label="XdgWindowEventMailbox\n(Resize/Close)", shape=cylinder];
        }

        subgraph cluster_mailbox_control {
            label="Control & Status";
            style=dashed;

            emu_cmd_mb [label="EmulationCommandMailbox\n(Pause/Reset)", shape=cylinder];
            emu_status_mb [label="EmulationStatusMailbox\n(Running)", shape=cylinder];
            speed_mb [label="SpeedControlMailbox\n(Fast-Forward)", shape=cylinder];
        }
    }

    // ========== EMULATION STATE ==========
    subgraph cluster_emulation {
        label="Emulation Core\n(State/Logic Separation)";
        style=filled;
        fillcolor=lightgreen;

        subgraph cluster_emu_state {
            label="EmulationState.zig";
            style=filled;
            fillcolor=palegreen;

            emu_state [label="EmulationState\n(Coordinator)", fillcolor=lightgreen, shape=box3d];
            master_clock [label="MasterClock\n(Cycle Counting)", fillcolor=lightyellow];
            vblank_ledger [label="VBlankLedger\n(NMI Edge Detection)", fillcolor=lightyellow];
            bus_state [label="BusState\n(RAM + Open Bus)", fillcolor=lightyellow];
        }

        subgraph cluster_cpu {
            label="CPU (6502)";
            style=filled;
            fillcolor=lightblue;

            cpu_state [label="CpuState\n(Registers)", fillcolor=lightblue];
            cpu_logic [label="CpuLogic\n(Pure Functions)", fillcolor=skyblue];
            cpu_execution [label="execution.zig\n(Cycle State Machine)", fillcolor=skyblue];
            cpu_opcodes [label="opcodes/\n(256 Instructions)", fillcolor=skyblue];
            cpu_dispatch [label="dispatch.zig\n(Opcode Routing)", fillcolor=skyblue];
        }

        subgraph cluster_ppu {
            label="PPU (2C02)";
            style=filled;
            fillcolor=lightcoral;

            ppu_state [label="PpuState\n(VRAM + OAM)", fillcolor=lightcoral];
            ppu_logic [label="PpuLogic\n(Pure Functions)", fillcolor=salmon];
            ppu_emu [label="Ppu.zig\n(Emulation Helpers)", fillcolor=salmon];
            ppu_rendering [label="Background + Sprites\n(Rendering Pipeline)", fillcolor=salmon];
            ppu_registers [label="registers.zig\n($2000-$2007)", fillcolor=salmon];
        }

        subgraph cluster_apu {
            label="APU (Audio)";
            style=filled;
            fillcolor=plum;

            apu_state [label="ApuState\n(Channels)", fillcolor=plum];
            apu_logic [label="ApuLogic\n(Pure Functions)", fillcolor=orchid];
            apu_channels [label="Pulse/Triangle/Noise/DMC\n(Sound Synthesis)", fillcolor=orchid];
        }

        subgraph cluster_peripherals {
            label="Peripherals";
            style=dashed;

            controller [label="ControllerState\n(Shift Registers)", fillcolor=wheat];
            oam_dma [label="OamDma\n(Sprite DMA)", fillcolor=wheat];
            dmc_dma [label="DmcDma\n(Audio DMA)", fillcolor=wheat];
        }

        subgraph cluster_cartridge {
            label="Cartridge System";
            style=filled;
            fillcolor=lightyellow;

            cart_registry [label="AnyCartridge\n(Tagged Union)", fillcolor=yellow];
            mapper0 [label="Mapper0\n(NROM)", fillcolor=khaki];
            ines_parser [label="iNES Parser\n(ROM Loading)", fillcolor=khaki];
        }
    }

    // ========== BUS ROUTING ==========
    subgraph cluster_bus {
        label="Memory Bus Routing";
        style=filled;
        fillcolor=lightgoldenrodyellow;

        bus_routing [label="bus/routing.zig\n(Read/Write Routing)", fillcolor=gold];
        bus_inspection [label="bus/inspection.zig\n(Peek/Poke)", fillcolor=gold];
    }

    // ========== DEBUGGER ==========
    subgraph cluster_debugger {
        label="Debugger System\n(RT-Safe)";
        style=filled;
        fillcolor=lightsteelblue;

        debugger [label="Debugger.zig\n(Main Interface)", fillcolor=steelblue];
        breakpoints [label="Breakpoints\n(PC-based)", fillcolor=lightsteelblue];
        watchpoints [label="Watchpoints\n(Memory)", fillcolor=lightsteelblue];
        stepping [label="Stepping\n(Single-Step)", fillcolor=lightsteelblue];
        history [label="History\n(Ring Buffer)", fillcolor=lightsteelblue];
        modification [label="Modification\n(Runtime Edits)", fillcolor=lightsteelblue];
    }

    // ========== VIDEO RENDERING ==========
    subgraph cluster_video {
        label="Video Rendering\n(Wayland + Vulkan)";
        style=filled;
        fillcolor=mistyrose;

        wayland_state [label="WaylandState\n(Window State)", fillcolor=lightcoral];
        wayland_logic [label="WaylandLogic\n(XDG Shell)", fillcolor=lightcoral];
        vulkan_state [label="VulkanState\n(Rendering State)", fillcolor=lightcoral];
        vulkan_logic [label="VulkanLogic\n(Pipeline)", fillcolor=lightcoral];
        shaders [label="shaders/\n(GLSL)", fillcolor=lightcoral];
    }

    // ========== UTILITIES ==========
    subgraph cluster_utils {
        label="Utility Systems";
        style=filled;
        fillcolor=lightgray;

        config [label="Config\n(TOML Parser)", fillcolor=lightgray];
        snapshot [label="Snapshot\n(Save States)", fillcolor=lightgray];
        timing [label="FrameTimer\n(60 FPS Pacing)", fillcolor=lightgray];
    }

    // ========== MAIN CONNECTIONS ==========
    main -> main_thread [label="spawn", color=blue, penwidth=2];
    main -> emu_thread [label="spawn", color=green, penwidth=2];
    main -> render_thread [label="spawn", color=red, penwidth=2];

    // Thread to Mailbox connections
    emu_thread -> frame_mb [label="produce", color=green];
    render_thread -> frame_mb [label="consume", color=red];

    main_thread -> ctrl_mb [label="produce", color=blue];
    emu_thread -> ctrl_mb [label="consume", color=green];

    main_thread -> dbg_cmd_mb [label="produce", color=blue];
    emu_thread -> dbg_cmd_mb [label="consume", color=green];
    emu_thread -> dbg_evt_mb [label="produce", color=green];
    main_thread -> dbg_evt_mb [label="consume", color=blue];

    render_thread -> xdg_input_mb [label="produce", color=red];
    main_thread -> xdg_input_mb [label="consume", color=blue];

    // Emulation thread internal structure
    emu_thread -> emu_state [lhead=cluster_emu_state, color=green, penwidth=2];

    // EmulationState orchestration
    emu_state -> master_clock [label="tick()", color=black];
    emu_state -> cpu_state [label="stepCpuCycle()", color=blue];
    emu_state -> ppu_state [label="stepPpuCycle()", color=red];
    emu_state -> apu_state [label="stepApuCycle()", color=purple];
    emu_state -> vblank_ledger [label="NMI edge", style=dashed];
    emu_state -> bus_routing [lhead=cluster_bus, label="busRead/Write", color=orange];

    // CPU internal connections
    cpu_state -> cpu_logic [label="delegate", color=blue];
    cpu_logic -> cpu_execution [label="tick()", color=blue];
    cpu_execution -> cpu_dispatch [label="lookup", color=blue];
    cpu_dispatch -> cpu_opcodes [label="call", color=blue];

    // PPU internal connections
    ppu_state -> ppu_logic [label="delegate", color=red];
    ppu_logic -> ppu_rendering [label="render", color=red];
    ppu_logic -> ppu_registers [label="read/write", color=red];
    ppu_emu -> ppu_state [label="tick()", color=red];
    ppu_emu -> ppu_logic [label="helpers", color=red, style=dashed];

    // APU internal connections
    apu_state -> apu_logic [label="delegate", color=purple];
    apu_logic -> apu_channels [label="tick", color=purple];

    // Bus routing connections
    bus_routing -> ppu_registers [label="$2000-$3FFF", color=red];
    bus_routing -> apu_logic [label="$4000-$4017", color=purple];
    bus_routing -> cart_registry [label="$4020-$FFFF", color=yellow];
    bus_routing -> bus_state [label="$0000-$1FFF\n(RAM)", color=gray];

    // Cartridge connections
    cart_registry -> mapper0 [label="dispatch", color=yellow];
    mapper0 -> ines_parser [label="loaded by", color=yellow, style=dashed];

    // Debugger connections
    emu_state -> debugger [label="integrate", color=steelblue];
    debugger -> breakpoints [label="check", color=steelblue];
    debugger -> watchpoints [label="check", color=steelblue];
    debugger -> stepping [label="control", color=steelblue];
    debugger -> history [label="record", color=steelblue];
    debugger -> modification [label="apply", color=steelblue];

    // Render thread connections
    render_thread -> wayland_state [lhead=cluster_video, color=red, penwidth=2];
    wayland_state -> wayland_logic [label="dispatch", color=red];
    vulkan_state -> vulkan_logic [label="render", color=red];
    vulkan_logic -> shaders [label="load", color=red];

    // Utility connections
    main -> config [label="parse", color=blue];
    emu_state -> snapshot [label="save/load", style=dashed];
    render_thread -> timing [label="pace", color=red];

    // Key architectural patterns (legend)
    subgraph cluster_legend {
        label="Architecture Patterns";
        style=filled;
        fillcolor=white;
        rank=sink;

        legend_state [label="State/Logic Separation\n(Pure Functions)", shape=note, fillcolor=lightyellow];
        legend_comptime [label="Comptime Generics\n(Zero-Cost Polymorphism)", shape=note, fillcolor=lightcyan];
        legend_rtsafe [label="RT-Safe\n(No Heap Allocations)", shape=note, fillcolor=lightgreen];
        legend_mailbox [label="Lock-Free Mailboxes\n(SPSC Ring Buffers)", shape=note, fillcolor=lavender];
    }

    // Pattern annotations
    emu_thread -> legend_rtsafe [style=dotted, color=gray];
    emu_state -> legend_state [style=dotted, color=gray];
    cart_registry -> legend_comptime [style=dotted, color=gray];
    frame_mb -> legend_mailbox [style=dotted, color=gray];
}
