// BIT $2002 Investigation Workflow - 2025-10-09
// This diagram shows the complete investigation process from hypothesis to conclusion

digraph Investigation_Workflow {
    // Graph settings
    rankdir=TB;
    compound=true;
    splines=ortho;
    nodesep=0.6;
    ranksep=1.0;

    // Node defaults
    node [shape=box, style=filled, fillcolor=lightgray, fontname="Arial"];
    edge [fontname="Arial", fontsize=10];

    // ========== INITIAL PROBLEM ==========
    subgraph cluster_problem {
        label="Initial Problem Statement";
        style=filled;
        fillcolor=mistyrose;

        smb_blank [label="Super Mario Bros\nBlank Screen", fillcolor=lightcoral, shape=box3d];
        test_fail [label="VBlank Wait Tests\nTiming Out", fillcolor=lightcoral, shape=box3d];

        hypothesis_initial [label="HYPOTHESIS:\nBIT $2002 instruction\nreads operand at wrong cycle", fillcolor=yellow, shape=note];
    }

    // ========== PHASE 1: RESEARCH ==========
    subgraph cluster_phase1 {
        label="Phase 1: Hardware Specification Research";
        style=filled;
        fillcolor=lightcyan;

        nesdev_bit [label="NESdev.org:\nBIT Instruction", fillcolor=lightyellow];
        nesdev_abs [label="Absolute Addressing:\n4 Cycles", fillcolor=lightyellow];
        nesdev_2002 [label="$2002 Side Effect:\nClear VBlank Immediately", fillcolor=lightyellow];

        spec_verified [label="✅ Hardware Spec\nVerified", fillcolor=lightgreen, shape=box3d];
    }

    // ========== PHASE 2: CODE AUDIT ==========
    subgraph cluster_phase2 {
        label="Phase 2: Code Audit";
        style=filled;
        fillcolor=lightblue;

        subgraph cluster_audit_files {
            label="Files Audited";
            style=dashed;

            audit_exec [label="execution.zig\n(lines 627-690)", fillcolor=lightblue];
            audit_regs [label="registers.zig\n(lines 20-106)", fillcolor=lightblue];
            audit_route [label="routing.zig\n(lines 12-79)", fillcolor=lightblue];
            audit_ppu [label="Ppu.zig\n(lines 154-178)", fillcolor=lightblue];
        }

        subgraph cluster_audit_findings {
            label="Audit Findings";
            style=dashed;

            finding_addr [label="Addressing Mode:\nCycles 2-3 calc address", fillcolor=palegreen];
            finding_exec [label="Execute Phase:\nCycle 4 reads operand", fillcolor=palegreen];
            finding_read [label="busRead() Route:\n→ PpuLogic.readRegister", fillcolor=palegreen];
            finding_clear [label="Register Read:\nClears VBlank line 46", fillcolor=palegreen];
        }

        audit_conclusion [label="✅ Implementation\nMatches Hardware", fillcolor=lightgreen, shape=box3d];
    }

    // ========== PHASE 3: DIAGNOSTICS ==========
    subgraph cluster_phase3 {
        label="Phase 3: Diagnostic Instrumentation";
        style=filled;
        fillcolor=lightyellow;

        subgraph cluster_diag_code {
            label="Diagnostic Code Added";
            style=dashed;

            diag_before [label="Capture VBlank\nBefore Read", fillcolor=lightyellow];
            diag_read [label="Execute busRead()", fillcolor=lightyellow];
            diag_after [label="Capture VBlank\nAfter Read", fillcolor=lightyellow];
            diag_timing [label="Log Scanline/Dot", fillcolor=lightyellow];
            diag_value [label="Log Read Value", fillcolor=lightyellow];
        }

        diag_output [label="Diagnostic Format:\n[EXECUTE PHASE] opcode=0x2C $2002\nat scanline=X, dot=Y,\nread value=0xZZ,\nVBlank before=B after=A", fillcolor=wheat, shape=note];
    }

    // ========== PHASE 4: TEST ANALYSIS ==========
    subgraph cluster_phase4 {
        label="Phase 4: Test Execution & Analysis";
        style=filled;
        fillcolor=lavender;

        subgraph cluster_passing {
            label="Passing Tests";
            style=filled;
            fillcolor=palegreen;

            test_pass_manual [label="Integration Tests\n(Manual VBlank Set)", fillcolor=lightgreen];
            output_pass [label="Output:\nvalue=0x80,\nbefore=true after=false", fillcolor=lightgreen, shape=note];
        }

        subgraph cluster_failing {
            label="Failing Tests";
            style=filled;
            fillcolor=lightcoral;

            test_fail_vblank [label="VBlank Wait Test\n(Natural Timing)", fillcolor=lightcoral];
            test_fail_polling [label="PPUSTATUS Polling\n(Natural Timing)", fillcolor=lightcoral];

            output_fail_bit [label="BIT Output:\nvalue=0x00,\nbefore=false after=false\nScanlines 0-17 only!", fillcolor=lightcoral, shape=note];
            output_fail_lda [label="LDA Output:\nvalue=0x1A,\nbefore=false after=false\nScanlines 0-17 only!", fillcolor=lightcoral, shape=note];
        }

        analysis_key [label="KEY FINDING:\nTests timeout BEFORE\nreaching scanline 241", fillcolor=yellow, shape=box3d];
    }

    // ========== PHASE 5: ROOT CAUSE ==========
    subgraph cluster_phase5 {
        label="Phase 5: Root Cause Identification";
        style=filled;
        fillcolor=lightgreen;

        root_cause [label="ROOT CAUSE:\nPPU/CPU Timing Issue\nTests never reach VBlank", fillcolor=lightgreen, shape=box3d];

        subgraph cluster_evidence {
            label="Evidence";
            style=dashed;

            evidence_manual [label="Manual VBlank:\n✅ Works Perfectly", fillcolor=palegreen];
            evidence_natural [label="Natural VBlank:\n❌ Never Arrives", fillcolor=lightcoral];
            evidence_timing [label="Expected:\nScanline 241 @ 82,181 PPU cycles", fillcolor=wheat];
            evidence_actual [label="Actual:\nTests timeout @ scanline 0-17", fillcolor=lightcoral];
        }

        hypothesis_corrected [label="CORRECTED HYPOTHESIS:\nBIT $2002 timing is CORRECT.\nIssue is frame timing or\nPPU advancement rate.", fillcolor=lightgreen, shape=note];
    }

    // ========== DELIVERABLES ==========
    subgraph cluster_deliverables {
        label="Investigation Deliverables";
        style=filled;
        fillcolor=lightsteelblue;

        doc_investigation [label="bit-ppustatus-investigation\n-2025-10-09.md", fillcolor=lightyellow, shape=folder];
        doc_matrix [label="flag-permutation-matrix.md\n(78 Verified Behaviors)", fillcolor=lightyellow, shape=folder];
        doc_session [label="session-summary\n-2025-10-09-part2.md", fillcolor=lightyellow, shape=folder];
        doc_audits [label="CPU/PPU Audit Reports\n(100% + 97.9% Correct)", fillcolor=lightyellow, shape=folder];
    }

    // ========== NEXT STEPS ==========
    subgraph cluster_next {
        label="Recommended Next Steps";
        style=filled;
        fillcolor=lightcyan;

        next_ppu [label="1. Profile PPU/CPU\nTick Ratio (3:1)", fillcolor=lightcyan];
        next_frame [label="2. Analyze Frame\nAdvancement Logic", fillcolor=lightcyan];
        next_clock [label="3. Review MasterClock\nImplementation", fillcolor=lightcyan];
        next_rom [label="4. Profile Test ROM\nExecution Path", fillcolor=lightcyan];
    }

    // ========== WORKFLOW CONNECTIONS ==========

    // Problem to Phase 1
    smb_blank -> hypothesis_initial;
    test_fail -> hypothesis_initial;
    hypothesis_initial -> nesdev_bit [label="research", color=blue];

    // Phase 1 Research
    nesdev_bit -> nesdev_abs;
    nesdev_abs -> nesdev_2002;
    nesdev_2002 -> spec_verified;

    // Phase 1 to Phase 2
    spec_verified -> audit_exec [label="audit code", color=green, lhead=cluster_audit_files];

    // Phase 2 Audit Flow
    audit_exec -> finding_addr;
    audit_regs -> finding_clear;
    audit_route -> finding_read;
    audit_ppu -> finding_clear;

    finding_addr -> finding_exec -> finding_read -> finding_clear;
    finding_clear -> audit_conclusion;

    // Phase 2 to Phase 3
    audit_conclusion -> diag_before [label="instrument", color=orange, lhead=cluster_diag_code];

    // Phase 3 Diagnostic Flow
    diag_before -> diag_read -> diag_after;
    diag_timing -> diag_output;
    diag_value -> diag_output;

    // Phase 3 to Phase 4
    diag_output -> test_pass_manual [label="run tests", color=purple];
    diag_output -> test_fail_vblank;

    // Phase 4 Test Analysis
    test_pass_manual -> output_pass;
    test_fail_vblank -> output_fail_bit;
    test_fail_polling -> output_fail_lda;

    output_pass -> analysis_key;
    output_fail_bit -> analysis_key;
    output_fail_lda -> analysis_key;

    // Phase 4 to Phase 5
    analysis_key -> root_cause [label="conclude", color=red, penwidth=2];

    // Phase 5 Root Cause Analysis
    root_cause -> evidence_manual;
    root_cause -> evidence_natural;
    evidence_manual -> evidence_timing;
    evidence_natural -> evidence_actual;

    evidence_timing -> hypothesis_corrected;
    evidence_actual -> hypothesis_corrected;

    // Root Cause to Deliverables
    hypothesis_corrected -> doc_investigation [lhead=cluster_deliverables, label="document", color=blue, penwidth=2];

    // Deliverables to Next Steps
    doc_investigation -> next_ppu [lhead=cluster_next, label="recommend", color=green, style=dashed];

    // Timeline annotation
    subgraph cluster_timeline {
        label="Investigation Timeline";
        style=filled;
        fillcolor=white;
        rank=sink;

        time_start [label="Start:\n2025-10-09\n14:00", shape=note];
        time_phase1 [label="Phase 1:\n~30 min", shape=note];
        time_phase2 [label="Phase 2:\n~45 min", shape=note];
        time_phase3 [label="Phase 3:\n~30 min", shape=note];
        time_phase4 [label="Phase 4:\n~45 min", shape=note];
        time_phase5 [label="Phase 5:\n~30 min", shape=note];
        time_end [label="End:\n2025-10-09\n17:00", shape=note];
    }

    // Status legend
    subgraph cluster_legend {
        label="Status Legend";
        style=filled;
        fillcolor=white;
        rank=sink;

        legend_verified [label="✅ Verified Correct", fillcolor=lightgreen, shape=box];
        legend_broken [label="❌ Identified Issue", fillcolor=lightcoral, shape=box];
        legend_hypothesis [label="Hypothesis", fillcolor=yellow, shape=note];
        legend_finding [label="Key Finding", fillcolor=lightyellow, shape=box3d];
    }
}
