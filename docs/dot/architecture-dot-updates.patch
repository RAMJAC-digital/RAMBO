// RAMBO Architecture Diagram - Recommended Updates
// Based on audit conducted 2025-10-13
// Priority: P0 (Critical), P1 (High), P2 (Low)

// ============================================================================
// P0 UPDATE 1: Enhance VBlankLedger Node Description
// ============================================================================
// Location: Line 83
// Current:
//   vblank_ledger [label="VBlankLedger\n(NMI Edge Detection)", fillcolor=lightyellow];
//
// Replace with:

vblank_ledger [label="VBlankLedger\n(NMI Edge Detection)\n\nTimestamp State:\n• last_set_cycle: u64\n• last_clear_cycle: u64\n• last_read_cycle: u64\n\nCritical Architecture:\n• Single source of truth for NMI\n• Decouples CPU NMI latch from\n  readable PPU status flag\n• Enables cycle-accurate\n  race condition handling\n  at scanline 241, dot 1", fillcolor=lightyellow, shape=component];

// ============================================================================
// P0 UPDATE 2: Add VBlankLedger Data Flow Edges
// ============================================================================
// Location: After line 218 (existing emu_state -> vblank_ledger edge)
// Add these edges:

    // VBlank event flow: PPU sets/clears VBlank flag
    ppu_state -> vblank_ledger [label="VBlank set/clear\n(timestamp recording)", color=red, style=bold, penwidth=2];

    // NMI edge detection: VBlankLedger signals CPU
    vblank_ledger -> cpu_state [label="NMI edge\n(shouldAssertNmiLine())", color=blue, style=bold, penwidth=2];

    // $2002 read coordination: Bus reads query VBlankLedger
    bus_routing -> vblank_ledger [label="$2002 read\n(race detection)", color=orange, style=dashed];

// ============================================================================
// P0 UPDATE 3: Add VBlank Architecture Migration Note
// ============================================================================
// Location: In legend section, after line 278 (legend_mailbox)
// Add this note:

    legend_vblank [label="VBlank Architecture (Phase 4):\n\nVBlank flag MIGRATED from PpuStatus\nto VBlankLedger for cycle-accurate\nNMI edge detection.\n\nKey Benefits:\n• Decouples CPU NMI latch from\n  readable PPU flag\n• Enables accurate race condition\n  handling at scanline 241, dot 1\n• Single source of truth for\n  VBlank timing state", shape=note, fillcolor=lightpink];

    // Connect note to relevant components
    ppu_state -> legend_vblank [style=dotted, color=gray];
    vblank_ledger -> legend_vblank [style=dotted, color=gray];

// ============================================================================
// P1 UPDATE 1: Update PPU Registers Description
// ============================================================================
// Location: Line 108
// Current:
//   ppu_registers [label="registers.zig\n($2000-$2007)", fillcolor=salmon];
//
// Replace with:

ppu_registers [label="registers.zig\n($2000-$2007)\n\nNOTE: VBlank flag removed\nfrom PpuStatus (Phase 4).\nNow queried from VBlankLedger\nfor cycle-accurate reads.", fillcolor=salmon];

// ============================================================================
// P1 UPDATE 2: Add Execution Order Note
// ============================================================================
// Location: Add to cluster_utils or as separate note after line 188
// Add this note:

    execution_order [label="Tick Execution Order:\n\n1. nextTimingStep()\n   • Advance master clock\n   • Handle odd frame skip\n\n2. PPU tick\n   • Render pipeline\n   • May set/clear VBlank flag\n   • Updates VBlankLedger timestamps\n\n3. APU tick (every 3 PPU cycles)\n   • Update frame counter\n   • Update IRQ state\n\n4. CPU tick (every 3 PPU cycles)\n   • Poll NMI from VBlankLedger\n   • Poll IRQ from APU/mapper\n   • Execute microstep", shape=note, fillcolor=lightcyan];

    // Connect to emulation state
    emu_state -> execution_order [style=dotted, color=gray];

// ============================================================================
// P2 UPDATE 1: Add DMA Coordination Note
// ============================================================================
// Location: In cluster_peripherals, after line 129
// Add this note:

    dma_timing [label="DMA Timing Behavior:\n\nOamDma ($4014):\n• Halts CPU for 513-514 cycles\n• Transfers 256 bytes OAM → PPU\n• Timing depends on write cycle\n  (odd/even alignment)\n\nDmcDma (DPCM samples):\n• Stalls CPU 1-4 cycles per fetch\n• Concurrent with normal execution\n• RDY line coordination", shape=note, fillcolor=wheat];

    // Connect to DMA components
    oam_dma -> dma_timing [style=dotted, color=gray];
    dmc_dma -> dma_timing [style=dotted, color=gray];

// ============================================================================
// P2 UPDATE 2: Update Diagram Metadata
// ============================================================================
// Location: Lines 2-4
// Current:
//   // Generated: 2025-10-09
//   // Updated: 2025-10-13 (Phase 5: APU State/Logic separation complete, Config module active)
//
// Replace with:

// Generated: 2025-10-09
// Updated: 2025-10-13 (Phase 5: APU State/Logic separation complete)
// Audited: 2025-10-13 (VBlankLedger integration, execution order documentation)

// ============================================================================
// VALIDATION COMMANDS
// ============================================================================
// After applying updates, validate with:
//
// 1. Check GraphViz syntax:
//    dot -Tpng docs/dot/architecture.dot -o /tmp/architecture-test.png
//
// 2. Verify all nodes referenced:
//    grep -o '\w\+\s*\[label=' docs/dot/architecture.dot | sort -u
//
// 3. Verify all edges have valid endpoints:
//    grep -oP '\w+\s*->\s*\w+' docs/dot/architecture.dot | sort -u
//
// 4. Visual inspection:
//    xdg-open /tmp/architecture-test.png
//
// ============================================================================
// IMPLEMENTATION CHECKLIST
// ============================================================================
// [ ] P0 UPDATE 1: Enhanced VBlankLedger node description
// [ ] P0 UPDATE 2: Added VBlankLedger data flow edges (3 edges)
// [ ] P0 UPDATE 3: Added VBlank architecture migration note
// [ ] P1 UPDATE 1: Updated PPU registers description
// [ ] P1 UPDATE 2: Added execution order note
// [ ] P2 UPDATE 1: Added DMA coordination note
// [ ] P2 UPDATE 2: Updated diagram metadata
// [ ] VALIDATION: GraphViz syntax check passed
// [ ] VALIDATION: Visual inspection passed
// [ ] DOCUMENTATION: Updated CLAUDE.md to reference audit report
//
// ============================================================================
// CROSS-REFERENCE
// ============================================================================
// Audit Report: docs/dot/architecture-dot-audit-2025-10-13.md
// Related Diagrams:
//   - docs/dot/emulation-coordination.dot (detailed emulation loop)
//   - docs/dot/cpu-module-structure.dot (CPU subsystem)
//   - docs/dot/ppu-module-structure.dot (PPU subsystem)
//
// Code References:
//   - src/emulation/State.zig (EmulationState with VBlankLedger)
//   - src/emulation/VBlankLedger.zig (VBlankLedger implementation)
//   - src/ppu/State.zig (PpuStatus without VBlank flag)
//   - src/ppu/logic/registers.zig (buildStatusByte with VBlankLedger query)
//
// ============================================================================
