// NTSC PPU Timing Reference - Hardware Specifications
// NES 2C02 Picture Processing Unit Timing Constants
//
// This is a PERMANENT REFERENCE documenting NES hardware timing.
// For historical investigations, see docs/archive/2025-10/
//
// Created: 2025-10-16 (extracted from investigation diagram)
// Hardware: NTSC NES (2C02 PPU)

digraph PPU_NTSC_Timing_Reference {
    // Graph settings
    rankdir=TB;
    compound=true;
    splines=ortho;
    nodesep=0.8;
    ranksep=1.0;

    // Node defaults
    node [shape=box, style=filled, fillcolor=lightgray, fontname="Arial"];
    edge [fontname="Arial", fontsize=10];

    // ========== FRAME STRUCTURE ==========
    subgraph cluster_frame {
        label="NTSC Frame Structure\n262 Scanlines × 341 Dots = 89,342 PPU Cycles";
        style=filled;
        fillcolor=lightcyan;

        frame_start [label="Frame Start\nScanline 0, Dot 0", fillcolor=lightblue, shape=box3d];
        frame_end [label="Frame End\nScanline 261, Dot 340", fillcolor=lightblue, shape=box3d];

        frame_total [label="Total Frame Time:\n89,342 PPU cycles\n= 29,780.67 CPU cycles\n= ~16.67 ms @ 60 Hz", fillcolor=wheat, shape=note];
    }

    // ========== SCANLINE REGIONS ==========
    subgraph cluster_regions {
        label="Scanline Regions";
        style=filled;
        fillcolor=lavender;

        subgraph cluster_visible {
            label="Visible Scanlines (0-239)";
            style=filled;
            fillcolor=lightgreen;

            visible_start [label="Scanline 0\nFirst Visible Line", fillcolor=palegreen];
            visible_mid [label="Scanlines 1-238\nRendering Active", fillcolor=lightgreen];
            visible_end [label="Scanline 239\nLast Visible Line", fillcolor=palegreen];

            visible_timing [label="240 visible scanlines\n× 341 dots = 81,840 PPU cycles", fillcolor=wheat, shape=note];
        }

        subgraph cluster_postrender {
            label="Post-Render (240)";
            style=filled;
            fillcolor=lightyellow;

            postrender [label="Scanline 240\nPost-Render\n(Idle)", fillcolor=lightyellow];
            postrender_timing [label="341 PPU cycles", fillcolor=wheat, shape=note];
        }

        subgraph cluster_vblank {
            label="VBlank Period (241-260)";
            style=filled;
            fillcolor=lightcoral;

            vblank_start [label="Scanline 241\nVBlank Starts", fillcolor=lightcoral, shape=box3d];
            vblank_mid [label="Scanlines 242-259\nVBlank Active", fillcolor=lightcoral];
            vblank_end [label="Scanline 260\nVBlank Ends", fillcolor=lightcoral, shape=box3d];

            vblank_timing [label="20 VBlank scanlines\n× 341 dots = 6,820 PPU cycles", fillcolor=wheat, shape=note];
        }

        subgraph cluster_prerender {
            label="Pre-Render (261)";
            style=filled;
            fillcolor=lightsteelblue;

            prerender [label="Scanline 261\nPre-Render\n(Setup Next Frame)", fillcolor=lightsteelblue];
            prerender_timing [label="341 PPU cycles\n(340 on odd frames)", fillcolor=wheat, shape=note];
        }
    }

    // ========== CRITICAL TIMING POINTS ==========
    subgraph cluster_critical {
        label="Critical Timing Points";
        style=filled;
        fillcolor=yellow;

        subgraph cluster_vblank_set {
            label="VBlank Flag SET";
            style=filled;
            fillcolor=lightcoral;

            set_timing [label="Scanline 241, Dot 1", fillcolor=yellow, shape=box3d];
            set_ppu_cycle [label="PPU Cycle: 82,181", fillcolor=wheat, shape=note];
            set_cpu_cycle [label="CPU Cycle: ~27,393", fillcolor=wheat, shape=note];
            set_action [label="PPU Action:\nVBlank flag = true\nIf NMI enabled → trigger", fillcolor=lightcoral, shape=note];
        }

        subgraph cluster_vblank_clear {
            label="VBlank Flag CLEAR";
            style=filled;
            fillcolor=lightsteelblue;

            clear_timing [label="Scanline 261, Dot 1", fillcolor=lightblue, shape=box3d];
            clear_ppu_cycle [label="PPU Cycle: 89,001", fillcolor=wheat, shape=note];
            clear_cpu_cycle [label="CPU Cycle: ~29,667", fillcolor=wheat, shape=note];
            clear_action [label="PPU Action:\nVBlank flag = false\nsprite_0_hit = false\nsprite_overflow = false", fillcolor=lightsteelblue, shape=note];
        }

        subgraph cluster_read_clear {
            label="VBlank Flag Clear on Read";
            style=dashed;

            read_timing [label="$2002 Read\n(Any Time)", fillcolor=lightyellow];
            read_action [label="Read Side Effect:\nVBlank flag = false\n(via VBlankLedger update)\ninternal.resetToggle()\nNMI latch persists!", fillcolor=lightcoral, shape=note];
        }
    }

    // ========== DOT STRUCTURE ==========
    subgraph cluster_dots {
        label="Dot (Pixel) Structure\n341 Dots per Scanline";
        style=filled;
        fillcolor=lightgoldenrodyellow;

        dots_visible [label="Dots 0-255\nVisible Pixels\n(256 dots)", fillcolor=lightgreen];
        dots_hblank [label="Dots 256-340\nHBlank\n(85 dots)", fillcolor=lightyellow];

        dots_fetch [label="Background Tile Fetching:\nDots 1-256, 321-336", fillcolor=lightcyan, shape=note];
        dots_sprites [label="Sprite Fetching:\nDots 257-320", fillcolor=orchid, shape=note];
    }

    // ========== VBLANK WAIT LOOP ==========
    subgraph cluster_vblank_wait {
        label="Typical VBlank Wait Loop\n(Used by most NES games)";
        style=filled;
        fillcolor=lightyellow;

        wait_code [label="Assembly Code:\n:vblankwait\n  BIT $2002\n  BPL vblankwait", fillcolor=wheat, shape=note];

        wait_behavior [label="Loop Behavior:\n1. Read $2002 (clears VBlank flag)\n2. Test bit 7 (N flag)\n3. If N=0 (no VBlank), branch back\n4. If N=1 (VBlank), continue", fillcolor=lightyellow, shape=note];

        wait_expected [label="Expected Execution:\nLoop polls $2002 until scanline 241.1\nVBlank sets → N=1 → exit loop", fillcolor=lightgreen, shape=note];
    }

    // ========== CPU/PPU SYNCHRONIZATION ==========
    subgraph cluster_sync {
        label="CPU/PPU Synchronization";
        style=filled;
        fillcolor=lightsteelblue;

        sync_ratio [label="Hardware Ratio:\n1 CPU cycle = 3 PPU cycles", fillcolor=yellow, shape=box3d];

        sync_master [label="MasterClock\nTracks both counters", fillcolor=lightblue, shape=cylinder];

        sync_tick [label="EmulationState.tick():\n1. Advance MasterClock\n2. PPU tick (every cycle)\n3. CPU tick (every 3 cycles)\n4. APU tick (with CPU)", fillcolor=lightsteelblue, shape=note];

        sync_frame [label="Frame Pacing:\n262 scanlines\n= 89,342 PPU cycles\n= 29,780.67 CPU cycles\n= 16.667 ms @ 60 Hz", fillcolor=wheat, shape=note];
    }

    // ========== MAIN FLOW ==========

    // Frame structure
    frame_start -> visible_start [label="begin frame", color=blue, penwidth=2];
    visible_start -> visible_mid [label="240 scanlines", color=green];
    visible_mid -> visible_end;
    visible_end -> postrender [label="scanline 240", color=orange];
    postrender -> vblank_start [label="scanline 241", color=red, penwidth=2];

    vblank_start -> vblank_mid [label="20 scanlines", color=red];
    vblank_mid -> vblank_end;
    vblank_end -> prerender [label="scanline 261", color=blue, penwidth=2];
    prerender -> frame_end [label="end frame", color=blue];
    frame_end -> frame_start [label="loop\n(odd frame: 340 dots)", style=dashed, color=blue];

    // Critical timing points
    vblank_start -> set_timing [label="VBlank SET", color=red, penwidth=2];
    set_timing -> set_ppu_cycle;
    set_timing -> set_cpu_cycle;
    set_timing -> set_action;

    prerender -> clear_timing [label="VBlank CLEAR", color=blue, penwidth=2];
    clear_timing -> clear_ppu_cycle;
    clear_timing -> clear_cpu_cycle;
    clear_timing -> clear_action;

    set_timing -> read_timing [label="or", style=dashed, color=orange];
    read_timing -> read_action;

    // VBlank wait loop
    wait_code -> wait_behavior;
    wait_behavior -> wait_expected [label="execution", color=green];
    set_timing -> wait_expected [label="arrive here", style=dashed, color=green];

    // Synchronization
    sync_ratio -> sync_master;
    sync_master -> sync_tick;
    sync_tick -> sync_frame;

    // Legend
    subgraph cluster_legend {
        label="Timing Legend";
        style=filled;
        fillcolor=white;
        rank=sink;

        legend_visible [label="Visible Scanlines\n(Rendering)", fillcolor=lightgreen, shape=box];
        legend_vblank [label="VBlank Period\n(CPU Work Time)", fillcolor=lightcoral, shape=box];
        legend_critical [label="Critical Timing", fillcolor=yellow, shape=box3d];
    }

    // Hardware specs
    subgraph cluster_specs {
        label="Hardware Specifications";
        style=filled;
        fillcolor=white;
        rank=sink;

        spec_freq [label="NTSC PPU: 5.369318 MHz", shape=note];
        spec_cpu [label="NTSC CPU: 1.789773 MHz", shape=note];
        spec_ratio [label="Ratio: 3:1 (PPU:CPU)", shape=note];
        spec_frame [label="Frame Rate: 60.0988 Hz", shape=note];
    }
}
