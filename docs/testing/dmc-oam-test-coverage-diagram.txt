DMC/OAM DMA Test Coverage - Visual Map
=========================================

Test Suite Structure (33+ tests)
---------------------------------

┌─────────────────────────────────────────────────────────────────────┐
│                    DMC/OAM DMA TEST PYRAMID                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│         ┌────────────────────────────────────┐                     │
│         │    Timing Tests (8)                │  ← Cycle-accurate   │
│         │  - Cycle counts                    │    verification     │
│         │  - CPU stall                       │                     │
│         │  - Priority                        │                     │
│         └────────────────────────────────────┘                     │
│                       ▲                                             │
│                       │                                             │
│        ┌──────────────────────────────────────┐                    │
│        │   Integration Tests (10)             │  ← Complex         │
│        │ - Multiple interrupts                │    multi-system    │
│        │ - Back-to-back OAM                   │    scenarios       │
│        │ - Edge cases                         │                    │
│        └──────────────────────────────────────┘                    │
│                       ▲                                             │
│                       │                                             │
│   ┌───────────────────────────────────────────────┐                │
│   │       Unit Tests (15)                         │  ← Simple      │
│   │  - DMC alone (3)                              │    isolated    │
│   │  - OAM alone (3)                              │    cases       │
│   │  - DMC interrupts OAM (9)                     │                │
│   └───────────────────────────────────────────────┘                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘


Test Category Breakdown
------------------------

UNIT TESTS (15 tests)
═════════════════════

┌── DMC DMA Alone (3) ──────────────────────────────────────┐
│                                                            │
│  1. ✓ Basic fetch (4 CPU cycles)                          │
│     └─ Verifies: DMC duration, RDY line behavior          │
│                                                            │
│  2. ✓ Sample byte fetched correctly                       │
│     └─ Verifies: Bus read, sample_byte field              │
│                                                            │
│  3. ✓ CPU stalled during fetch                            │
│     └─ Verifies: PC unchanged, no instruction execution   │
│                                                            │
└────────────────────────────────────────────────────────────┘

┌── OAM DMA Alone (3) ──────────────────────────────────────┐
│                                                            │
│  4. ✓ Basic transfer (existing test)                      │
│  5. ✓ Even cycle timing (existing test)                   │
│  6. ✓ Odd cycle timing (existing test)                    │
│                                                            │
└────────────────────────────────────────────────────────────┘

┌── DMC Interrupts OAM (9) ─────────────────────────────────┐
│                                                            │
│  7. ✗ Interrupt at start (byte 0)                         │
│     └─ Tests: Early interruption, pause/resume at start   │
│                                                            │
│  8. ✗ Interrupt mid-transfer (byte 128)                   │
│     └─ Tests: Middle interruption, partial transfer       │
│                                                            │
│  9. ✗ Interrupt at end (byte 255)                         │
│     └─ Tests: Late interruption, completion handling      │
│                                                            │
│ 10. ✗ Interrupt during read cycle                         │
│     └─ Tests: Read-phase interruption                     │
│                                                            │
│ 11. ✗ Interrupt during write cycle                        │
│     └─ Tests: Write-phase interruption                    │
│                                                            │
│ 12. ✗ Interrupt during alignment cycle                    │
│     └─ Tests: Odd-start alignment handling                │
│                                                            │
│ 13. ✗ Byte duplication verification                       │
│     └─ Tests: Exact duplicated byte value                 │
│                                                            │
│ 14. ✗ Offset advances correctly                           │
│     └─ Tests: OAM offset state during/after DMC           │
│                                                            │
│ 15. ✗ Pause flag behavior                                 │
│     └─ Tests: Paused state transitions                    │
│                                                            │
└────────────────────────────────────────────────────────────┘


INTEGRATION TESTS (10 tests)
═════════════════════════════

┌── Multiple DMC Interruptions (4) ─────────────────────────┐
│                                                            │
│ 16. ✗ Multiple interrupts during single OAM               │
│     └─ 3 DMC interrupts at bytes 50, 150, 250             │
│                                                            │
│ 17. ✗ Consecutive DMC interrupts (no gap)                 │
│     └─ Two DMCs back-to-back during OAM                   │
│                                                            │
│ 18. ✗ Interrupt during OAM resume                         │
│     └─ DMC interrupts while resuming from previous DMC    │
│                                                            │
│ 19. ✗ Maximum interruptions (stress test)                 │
│     └─ DMC every 10 cycles (unrealistic stress)           │
│                                                            │
└────────────────────────────────────────────────────────────┘

┌── Back-to-Back OAM DMAs (3) ──────────────────────────────┐
│                                                            │
│ 20. ✗ Sequential OAM with DMC between                     │
│     └─ OAM1 → DMC → OAM2 sequence                         │
│                                                            │
│ 21. ✗ Immediate second OAM after first                    │
│     └─ OAM1 → OAM2 (no gap)                               │
│                                                            │
│ 22. ✗ DMC interrupts both OAMs                            │
│     └─ OAM1 (with DMC) → OAM2 (with DMC)                  │
│                                                            │
└────────────────────────────────────────────────────────────┘

┌── Edge Cases (3) ─────────────────────────────────────────┐
│                                                            │
│ 23. ✗ DMC when OAM already complete                       │
│     └─ Tests: Independent DMC operation                   │
│                                                            │
│ 24. ✗ OAM triggered while DMC active                      │
│     └─ Tests: DMC priority when OAM starts                │
│                                                            │
│ 25. ✗ All bytes identical (off-by-one detection)          │
│     └─ Tests: Duplication detection with same values      │
│                                                            │
└────────────────────────────────────────────────────────────┘


TIMING TESTS (8 tests)
═══════════════════════

┌── Cycle Count Verification (4) ───────────────────────────┐
│                                                            │
│ 26. ✗ 1 DMC interrupt adds 4 cycles (513 → 517)           │
│     └─ Formula: 513 + (1 × 4) = 517                       │
│                                                            │
│ 27. ✗ 3 DMC interrupts add 12 cycles (513 → 525)          │
│     └─ Formula: 513 + (3 × 4) = 525                       │
│                                                            │
│ 28. ✗ Odd-start + DMC (514 + 4 = 518)                     │
│     └─ Formula: 514 + (1 × 4) = 518                       │
│                                                            │
│ 29. ✗ DMC during alignment doesn't affect total           │
│     └─ Still 514 + 4 = 518 (not 515 + 4)                  │
│                                                            │
└────────────────────────────────────────────────────────────┘

┌── CPU Stall Verification (2) ─────────────────────────────┐
│                                                            │
│ 30. ✗ CPU doesn't execute during OAM + DMC                │
│     └─ PC, SP unchanged during entire sequence            │
│                                                            │
│ 31. ✗ CPU resumes after both DMAs complete                │
│     └─ PC advances after DMAs finish                      │
│                                                            │
└────────────────────────────────────────────────────────────┘

┌── Priority Verification (2) ──────────────────────────────┐
│                                                            │
│ 32. ✗ DMC always preempts OAM                             │
│     └─ DMC runs first when both triggered simultaneously  │
│                                                            │
│ 33. ✗ Multiple DMCs execute in order                      │
│     └─ DMC1 → DMC2 without OAM interference               │
│                                                            │
└────────────────────────────────────────────────────────────┘


Test Pattern Usage
------------------

┌─────────────────────────────────────────────────────────────┐
│  Test Data Patterns                                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Sequential: 0x00, 0x01, 0x02, ..., 0xFF                    │
│  ├─ Use Case: Detect byte skipping, offset errors          │
│  └─ Tests: 7, 8, 9, 13, 14, 16, 17, 18                      │
│                                                             │
│  Repeating: 0xAA, 0xAA, 0xAA, ...                           │
│  ├─ Use Case: Mask duplication, test off-by-one            │
│  └─ Tests: 19, 25                                           │
│                                                             │
│  Alternating: 0xAA, 0x55, 0xAA, 0x55, ...                   │
│  ├─ Use Case: Detect byte swapping                         │
│  └─ Tests: 10, 11, 12                                       │
│                                                             │
│  Arithmetic: (i * 3) % 256                                  │
│  ├─ Use Case: Unique values, detect any duplication        │
│  └─ Tests: 13, 22                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘


Expected vs Actual Behavior Timeline
-------------------------------------

Normal OAM DMA (no DMC):
────────────────────────
Cycle 0-1:   [ALIGN] (if odd start)
Cycle 1-2:   Read byte 0, Write byte 0
Cycle 3-4:   Read byte 1, Write byte 1
Cycle 5-6:   Read byte 2, Write byte 2
...
Cycle 511-512: Read byte 255, Write byte 255
Total: 513 cycles (even) or 514 cycles (odd)


OAM DMA with DMC Interrupt:
────────────────────────────
Cycle 0-1:   [ALIGN] (if odd start)
Cycle 1-2:   Read byte 0, Write byte 0
Cycle 3-4:   Read byte 1, Write byte 1
Cycle 5:     Read byte 2  ← DMC INTERRUPT HERE!
Cycle 6-9:   [DMC DMA: 4 cycles, fetches sample]
Cycle 10:    Write byte 2 (using value from cycle 5)
Cycle 11-12: Read byte 2 AGAIN! ← DUPLICATION
Cycle 13-14: Write byte 2 (duplicate)
Cycle 15-16: Read byte 3, Write byte 3  ← Back to normal
...
Total: 513 + 4 = 517 cycles


Hardware Priority Enforcement:
───────────────────────────────
┌──────────────────────────────────┐
│   Priority Level   │   Action    │
├────────────────────┼─────────────┤
│   1. DMC DMA       │  Immediate  │  ← Highest (interrupts everything)
│   2. OAM DMA       │  Pauseable  │  ← Can be interrupted by DMC
│   3. CPU           │  Stalled    │  ← Lowest (waits for both)
└──────────────────────────────────┘


Legend
──────
✓ = Test exists and passes
✗ = Test to be written (will fail until implementation)
[ALIGN] = Alignment wait cycle (odd CPU cycle start)
← = Annotation/note


Test Execution Flow
───────────────────

1. ARRANGE
   ├─ Create harness
   ├─ Fill RAM with test pattern
   ├─ Seek to CPU boundary (if needed)
   └─ Setup initial state

2. ACT
   ├─ Trigger OAM DMA (write to $4014)
   ├─ Advance to interruption point
   ├─ Trigger DMC DMA (triggerFetch)
   ├─ Run until DMC completes
   └─ Run until OAM completes

3. ASSERT
   ├─ Verify DMA states (active, paused, rdy_low)
   ├─ Verify cycle counts (CPU and PPU)
   ├─ Verify OAM contents (expected pattern)
   └─ Verify CPU state (PC, SP unchanged)


Coverage Matrix
───────────────

┌────────────────┬─────┬─────┬─────┬─────┐
│  Feature       │Unit │Integ│Time │Total│
├────────────────┼─────┼─────┼─────┼─────┤
│ DMC alone      │  3  │  0  │  0  │  3  │
│ OAM alone      │  3  │  0  │  0  │  3  │
│ DMC interrupts │  9  │  0  │  0  │  9  │
│ Multiple DMC   │  0  │  4  │  0  │  4  │
│ Back-to-back   │  0  │  3  │  0  │  3  │
│ Edge cases     │  0  │  3  │  0  │  3  │
│ Cycle timing   │  0  │  0  │  4  │  4  │
│ CPU stall      │  0  │  0  │  2  │  2  │
│ Priority       │  0  │  0  │  2  │  2  │
├────────────────┼─────┼─────┼─────┼─────┤
│ TOTAL          │ 15  │ 10  │  8  │ 33  │
└────────────────┴─────┴─────┴─────┴─────┘


Estimated Test Runtime
──────────────────────

┌─────────────────────────────┬──────────┐
│  Test Category              │   Time   │
├─────────────────────────────┼──────────┤
│ Unit Tests (15)             │  ~30ms   │
│ Integration Tests (10)      │  ~40ms   │
│ Timing Tests (8)            │  ~20ms   │
│ Overhead (setup/teardown)   │  ~10ms   │
├─────────────────────────────┼──────────┤
│ TOTAL                       │ ~100ms   │
└─────────────────────────────┴──────────┘

Target: < 100ms for fast feedback
Actual: Will measure after implementation


Implementation Dependencies
────────────────────────────

Before tests pass, implementation must:

1. Add pause mechanism to OamDma
   ├─ paused: bool flag
   └─ last_read_byte: u8 field

2. Implement DMC priority in tick logic
   ├─ Check DMC active before OAM
   └─ Pause OAM when DMC triggers

3. Implement resume with duplication
   ├─ Detect resume condition
   ├─ Write last_read_byte to OAM
   └─ Advance offset correctly

4. Update cycle counting
   ├─ Track DMC interrupt cycles
   └─ Add to total OAM duration


Success Indicators
──────────────────

Before Implementation:
  Pass: 3/33 (9%)   ← DMC-alone tests
  Fail: 30/33 (91%) ← All interaction tests

After Implementation:
  Pass: 33/33 (100%) ← All tests
  Fail: 0/33 (0%)

Regression Check:
  oam_dma_test.zig: 14/14 passing ✓
  dpcm_dma_test.zig: 3/3 passing ✓
  Full suite: 990/995 (99.5%) ✓
